<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-2使用指南/7平台进阶配置/3废弃平台" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">废弃平台 | Lrobot</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://wwweibu.github.io/Lrobot/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://wwweibu.github.io/Lrobot/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://wwweibu.github.io/Lrobot/en/docs/2使用指南/7平台进阶配置/3废弃平台"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="废弃平台 | Lrobot"><meta data-rh="true" name="description" content="QQ 小程序、微博、微信开放平台、botpy、LLOneBot 开发代码"><meta data-rh="true" property="og:description" content="QQ 小程序、微博、微信开放平台、botpy、LLOneBot 开发代码"><link data-rh="true" rel="icon" href="/Lrobot/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://wwweibu.github.io/Lrobot/en/docs/2使用指南/7平台进阶配置/3废弃平台"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/en/docs/2使用指南/7平台进阶配置/3废弃平台" hreflang="en"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/docs/2使用指南/7平台进阶配置/3废弃平台" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/docs/2使用指南/7平台进阶配置/3废弃平台" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"使用指南","item":"https://wwweibu.github.io/Lrobot/en/docs/category/使用指南"},{"@type":"ListItem","position":2,"name":"平台进阶配置","item":"https://wwweibu.github.io/Lrobot/en/docs/category/平台进阶配置"},{"@type":"ListItem","position":3,"name":"废弃平台","item":"https://wwweibu.github.io/Lrobot/en/docs/2使用指南/7平台进阶配置/3废弃平台"}]}</script><link rel="stylesheet" href="/Lrobot/en/assets/css/styles.128759fc.css">
<script src="/Lrobot/en/assets/js/runtime~main.28f4417d.js" defer="defer"></script>
<script src="/Lrobot/en/assets/js/main.07e73115.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Lrobot/en/img/logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Lrobot/en/"><div class="navbar__logo"><img src="/Lrobot/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Lrobot/en/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Lrobot</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Lrobot/en/docs/category/项目总览">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/wwweibu/Lrobot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/en/docs/category/项目总览">项目总览</a><button aria-label="Expand sidebar category &#x27;项目总览&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Lrobot/en/docs/category/使用指南">使用指南</a><button aria-label="Collapse sidebar category &#x27;使用指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/1运行机配置">运行机配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/2Docker配置">Docker 配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/3平台配置">平台配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/4服务器配置">服务器配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/5后续开发">后续开发</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/Lrobot/en/docs/category/项目进阶配置">项目进阶配置</a><button aria-label="Expand sidebar category &#x27;项目进阶配置&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/Lrobot/en/docs/category/平台进阶配置">平台进阶配置</a><button aria-label="Collapse sidebar category &#x27;平台进阶配置&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Lrobot/en/docs/2使用指南/7平台进阶配置/3废弃平台">废弃平台</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/7平台进阶配置/平台回调原理">平台回调原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/en/docs/2使用指南/7平台进阶配置/平台审核">平台审核</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/Lrobot/en/docs/category/功能开发">功能开发</a><button aria-label="Expand sidebar category &#x27;功能开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/en/docs/category/开发指南">开发指南</a><button aria-label="Expand sidebar category &#x27;开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/en/docs/category/项目测试">项目测试</a><button aria-label="Expand sidebar category &#x27;项目测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Lrobot/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/Lrobot/en/docs/category/使用指南"><span>使用指南</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/Lrobot/en/docs/category/平台进阶配置"><span>平台进阶配置</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">废弃平台</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>废弃平台</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="qqapp参考">qqapp(<a href="https://q.qq.com/wiki/#_4-%E5%BC%80%E5%8F%91qq%E5%B0%8F%E7%A8%8B%E5%BA%8F" target="_blank" rel="noopener noreferrer">参考</a>)<a href="#qqapp参考" class="hash-link" aria-label="Direct link to qqapp参考" title="Direct link to qqapp参考">​</a></h2>
<ol>
<li>填写小程序名称、简介，上传图片，设置类目标签，提交备案</li>
<li>下载<a href="https://q.qq.com/wiki/tools/devtool/stable.html" target="_blank" rel="noopener noreferrer">开发工具</a></li>
<li><code>开发-开发设置</code>里记录 AppID 和 AppSecret</li>
<li><code>开发-开发设置</code> 里配置服务器域名</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="小程序开发qqapp">小程序开发(qqapp)<a href="#小程序开发qqapp" class="hash-link" aria-label="Direct link to 小程序开发(qqapp)" title="Direct link to 小程序开发(qqapp)">​</a></h4>
<ul>
<li>小程序用户验证<a href="https://q.qq.com/wiki/develop/miniprogram/API/open_port/port_userinfo.html" target="_blank" rel="noopener noreferrer">参考文档</a></li>
<li>小程序管理员认证在 connect.qq.com 申请获取用户 unionid ，使得管理员认证唯一，取代了之前使用用户昵称的方式</li>
<li>小程序页面跳转使用 navigateBack 代替 To 来避免10个页面的上限，并且修改/删除后还能回到原光标处,现在程序运行非常快</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="小程序图片压缩">小程序图片压缩<a href="#小程序图片压缩" class="hash-link" aria-label="Direct link to 小程序图片压缩" title="Direct link to 小程序图片压缩">​</a></h4>
<ul>
<li>参考代码：</li>
<li>压缩到50kb不影响缩略图观看</li>
<li>参考chatgpt的两个对话</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>物资租借小程序后端，含登录函数login</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 物资租借小程序接收消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import requests as re</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from fastapi import APIRouter, Request, UploadFile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from config import config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from log import loggers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from logic import (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    authenticate_user,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    query_material,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    delete_materials,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    update_materials,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_materials,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">router = APIRouter()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">adapter_logger = loggers[&quot;adapter&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.get(&quot;/login&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def material_login(nickname: str, code: str):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;&quot;&quot;登录&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if nickname in config[&quot;admin_nicknames&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 只处理管理员列表中的昵称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        response = re.get(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;https://api.q.qq.com/sns/jscode2session&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            params={</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;appid&quot;: config[&quot;QQAPP_ID&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;secret&quot;: config[&quot;QQAPP_SECRET&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;js_code&quot;: code,  # 用 encryptedData 作为 js_code 发送</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;grant_type&quot;: &quot;authorization_code&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 发送验证消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if response.status_code == 200:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            data = response.json()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            unionid = data.get(&quot;unionid&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # print(unionid) # 用于添加管理员，先把user_name添加进列表，然后查看打印出的unionid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if unionid in config[&quot;admin_uid&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    f&quot;⌈QQAPP⌋ 管理员{nickname}成功登录&quot;, extra={&quot;event&quot;: &quot;程序登录&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return {&quot;success&quot;: True, &quot;message&quot;: &quot;0&quot;}  # 管理员登录成功</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result = await authenticate_user(nickname, &quot;1&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if result == 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 用户{nickname}成功登录&quot;, extra={&quot;event&quot;: &quot;程序登录&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;1&quot;}  # 普通用户登录成功</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 用户{nickname}登录失败&quot;, extra={&quot;event&quot;: &quot;程序登录&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;2&quot;}  # 登录失败</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.get(&quot;/query&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def material_query(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nickname: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    code: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    selectedType: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 用户访问资源</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    auth_code = await authenticate_user(nickname, code)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if auth_code == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 陌生用户{nickname}访问资源列表&quot;, extra={&quot;event&quot;: &quot;资源访问&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;3&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if selectedType not in [&quot;boardgames&quot;, &quot;scriptmurders&quot;, &quot;publications&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 用户{nickname}访问无效的物资类型&quot;, extra={&quot;event&quot;: &quot;资源访问&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;4&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response_data = await query_material(selectedType)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        f&quot;⌈QQAPP⌋ 用户{nickname}获取物资列表成功&quot;, extra={&quot;event&quot;: &quot;资源访问&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return {&quot;success&quot;: True, &quot;message&quot;: &quot;5&quot;, &quot;data&quot;: response_data}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.get(&quot;/delete&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def material_delete(nickname: str, code: str, selectedType: str, originalID: str):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 管理员删除资源</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    auth_code = await authenticate_user(nickname, code)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if auth_code != 0:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 陌生用户{nickname}试图删除资源&quot;, extra={&quot;event&quot;: &quot;资源删除&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;6&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result = await delete_materials(selectedType, originalID)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if result == 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 管理{nickname}删除了ID为{originalID}的记录&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            extra={&quot;event&quot;: &quot;资源删除&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;9&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 管理{nickname}试图删除不存在的资源&quot;, extra={&quot;event&quot;: &quot;资源删除&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;7&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.post(&quot;/update&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def material_update(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nickname: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    code: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    selectedType: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    originalID: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    image: UploadFile,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    request: Request,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 管理员更新资源</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    auth_code = await authenticate_user(nickname, code)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if auth_code != 0:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 陌生用{nickname}试图修改资源&quot;, extra={&quot;event&quot;: &quot;资源修改&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;10&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if selectedType not in [&quot;boardgames&quot;, &quot;scriptmurders&quot;, &quot;publications&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 管理员{nickname}修改无效的物资类型&quot;, extra={&quot;event&quot;: &quot;资源修改&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;11&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result, original_data, filtered_new_values = await update_materials(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        selectedType, originalID, request, image</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if result == 0:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;⌈QQAPP⌋ 管理员{nickname}试图修改不存在的资源&quot;, extra={&quot;event&quot;: &quot;资源修改&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;12&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif result != -1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;管理员{nickname}试图把{originalID}修改成已经存在的id{result}&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            extra={&quot;event&quot;: &quot;资源修改&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;13&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;管理员{nickname}成功更新数据库{selectedType}:\n{original_data}\n{&#x27;, &#x27;.join(filtered_new_values)}&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            extra={&quot;event&quot;: &quot;资源修改&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;14&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.post(&quot;/add&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def material_add(nickname: str, code: str, selectedType: str, request: Request):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 管理员添加资源</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    auth_code = await authenticate_user(nickname, code)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if auth_code != 0:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;陌生用户{nickname}试图添加资源&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            extra={&quot;event&quot;: &quot;资源添加&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;15&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if selectedType not in [&quot;boardgames&quot;, &quot;scriptmurders&quot;, &quot;publications&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.error(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            f&quot;管理员{nickname} 添加无效的物资类型&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            extra={&quot;event&quot;: &quot;资源添加&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return {&quot;success&quot;: True, &quot;message&quot;: &quot;16&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filtered_new_values = await add_materials(selectedType, request)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    adapter_logger.info(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        f&quot;管理员{nickname}成功添加物资到数据库{selectedType}:\n{filtered_new_values}&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        extra={&quot;event&quot;: &quot;资源添加&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return {&quot;success&quot;: True, &quot;message&quot;: &quot;17&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># from config import config, update_database, query_database</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># TODO qq小程序合并到identify部分</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># async def authenticate_user(nickname, code):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 管理员身份确认</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     if nickname in config[&quot;admin_nicknames&quot;] and code == &quot;0&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         return 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     elif nickname in [&quot;One-8587&quot;, &quot;Two-8587&quot;, &quot;New Wave&quot;, &quot;梦周王良将舞&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 测试员账号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         return 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 从数据库中查找用户</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     user_found = await query_database(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         &quot;SELECT * FROM user_all WHERE qq_name = :nickname&quot;, {&quot;nickname&quot;: nickname}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     if user_found and code == &quot;1&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         return 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     return 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># # 仅作参考，到 abandoned</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># async def add_users(user_list, identity):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 更新 users_qq_nickname 表，如果 qq_number 存在则更新 nickname及identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     for user in user_list:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         qq_number = user[0]  # user_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         nickname = user[1]  # nickname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 查询当前用户的 identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         identity_query = &quot;SELECT identity FROM user_all WHERE qq_number = ?&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         current_identity = await query_database(identity_query, (qq_number,))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         if current_identity:  # 如果存在</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             current_identity = current_identity[0][0]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             # 更新 nickname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             update_nickname_query = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 &quot;UPDATE user_all SET nickname = ? WHERE qq_number = ?&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             await update_database(update_nickname_query, (nickname, qq_number))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             # 如果 identity 从 1 改为 2,则更新 identity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             if current_identity == 1 and identity == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 update_identity_query = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                     &quot;UPDATE user_all SET identity = ? WHERE qq_number = ?&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 await update_database(update_identity_query, (2, qq_number))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         else:  # 如果不存在，插入新记录</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             insert_query = &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             INSERT INTO user_all (qq_number, nickname, identity)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             VALUES (?, ?, ?)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             await update_database(insert_query, (qq_number, nickname, identity))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># async def users_all():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 删除表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     await update_database(&quot;DROP TABLE IF EXISTS users_all&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 创建表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     create_table_query = &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#            CREATE TABLE IF NOT EXISTS users_all (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                qq_number TEXT PRIMARY KEY,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                qq_name TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                identity TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                name TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                nickname TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                gender TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                grade TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                major TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                student_id TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                phone TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                political_status TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                hometown TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                card_number TEXT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                id TEXT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#            );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#            &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     await execute_update(create_table_query)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 获取 users_qq_nickname 表中的数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     users_qq_nickname_data = await execute_query(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         &quot;SELECT qq_number, nickname, identity FROM users_qq_nickname&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     # 插入合并数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#     for qq_number, qq_name, identity in users_qq_nickname_data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 查询对应的 users_info 数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         users_info_query = &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                SELECT 姓名, 代号, 性别, 年级, 专业, 学号, 电话, 政治面貌, 籍贯, 卡号, id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                FROM users_info</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                WHERE qq = ?</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         users_info_data = await execute_query(users_info_query, (qq_number,))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 默认将各字段设为 None，表示缺失</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         name = nickname = gender = grade = major = student_id = phone = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             political_status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         ) = hometown = card_number = user_id = None</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 如果找到对应的 users_info 数据，则更新各字段</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         if users_info_data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 name,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 nickname,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 gender,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 grade,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 major,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 student_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 phone,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 political_status,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 hometown,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 card_number,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 user_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             ) = users_info_data[0]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         # 插入到 users_all 表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         insert_query = &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                        INSERT INTO users_all (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                            qq_number, qq_name, identity, name, nickname, gender, grade,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                            major, student_id, phone, political_status, hometown, card_number, id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                        &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         await execute_update(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             insert_query,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 qq_number,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 qq_name,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 identity,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 name,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 nickname,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 gender,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 grade,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 major,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 student_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 phone,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 political_status,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 hometown,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 card_number,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#                 user_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#             ),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#         )</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="botpy">botpy<a href="#botpy" class="hash-link" aria-label="Direct link to botpy" title="Direct link to botpy">​</a></h2>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>botpy 逻辑</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;&quot;&quot;botpy 旧逻辑，使用需安装 botpy&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 把这两个函数在botpy/api.py的最下面，修改后可上传本地文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def post_group_file(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    group_openid: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    file_type: int,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    srv_send_msg: bool = False,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) -&gt; message.Media:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if os.path.isfile(url):  # 检查是否为本地文件路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 读取本地文件并编码为 base64</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        with open(url, &quot;rb&quot;) as f:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            file_data = base64.b64encode(f.read()).decode(&quot;utf-8&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:  # 假设传入的是 URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        response = requests.get(url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if response.status_code == 200:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            file_data = base64.b64encode(response.content).decode(&quot;utf-8&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            print(f&quot;下载文件失败，状态码: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    payload = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;group_openid&quot;: group_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;file_type&quot;: file_type,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;file_data&quot;: file_data,  # 使用 base64 编码的文件数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;srv_send_msg&quot;: srv_send_msg,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    route = Route(&quot;POST&quot;, &quot;/v2/groups/{group_openid}/files&quot;, group_openid=group_openid)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return await self._http.request(route, json=payload)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def post_c2c_file(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    openid: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    file_type: int,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url: str,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    srv_send_msg: bool = False,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) -&gt; message.Media:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if os.path.isfile(url):  # 检查是否为本地文件路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 读取本地文件并编码为 base64</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        with open(url, &quot;rb&quot;) as f:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            file_data = base64.b64encode(f.read()).decode(&quot;utf-8&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:  # 假设传入的是 URL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        response = requests.get(url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if response.status_code == 200:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            file_data = base64.b64encode(response.content).decode(&quot;utf-8&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            print(f&quot;下载文件失败，状态码: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    payload = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;openid&quot;: openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;file_type&quot;: file_type,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;file_data&quot;: file_data,  # 使用 base64 编码的文件数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;srv_send_msg&quot;: srv_send_msg,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    route = Route(&quot;POST&quot;, &quot;/v2/users/{openid}/files&quot;, openid=openid)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return await self._http.request(route, json=payload)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 下面的为主要代码，可参考 botpy 的 pythonsdk 中的包引入</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import re</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import botpy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from botpy.message import C2CMessage, GroupMessage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from log import loggers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from config import config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from message.handler.msg import Msg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">adapter_logger = loggers[&quot;adapter&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">global_api = {}  # 用于存储 message.api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def set_global_api(api):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 设置botpy的全局api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    global global_api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if &quot;api&quot; not in global_api:  # 只在第一次赋值</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        global_api[&quot;api&quot;] = api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyClient(botpy.Client):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #  官方QQ机器人客户端类</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    async def on_ready(self):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.debug(f&quot;⌈LR232⌋ 启动成功&quot;, extra={&quot;event&quot;: &quot;运行日志&quot;})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @staticmethod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    async def on_c2c_message_create(message: C2CMessage):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.debug(f&quot;⌈LR232⌋ 接收:{message}&quot;, extra={&quot;event&quot;: &quot;消息接收&quot;})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        set_global_api(message._api)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message.content = await msg_content_join(message.content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        files = {}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if message.attachments:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            for attachment in message.attachments:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                file_name = attachment.get(&quot;filename&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                file_url = attachment.get(&quot;url&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if file_name and file_url:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    files.append((file_name, file_url))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                robot=&quot;LR232&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind=&quot;私聊文件消息&quot; if message.content else &quot;私聊图文消息&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                event=&quot;处理&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                source=message.author.user_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seq=message.id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=message.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                files=files,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                robot=&quot;LR232&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind=&quot;私聊文字消息&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                event=&quot;处理&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                source=message.author.user_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seq=message.id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=message.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                files=files,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @staticmethod</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    async def on_group_at_message_create(message: GroupMessage):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        adapter_logger.debug(f&quot;⌈LR232⌋ 接收:{message}&quot;, extra={&quot;event&quot;: &quot;消息接收&quot;})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        set_global_api(message._api)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message.content = await msg_content_join(message.content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        files = {}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if message.attachments:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            for attachment in message.attachments:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                file_name = attachment.get(&quot;filename&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                file_url = attachment.get(&quot;url&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if file_name and file_url:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    files.append((file_name, file_url))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                robot=&quot;LR232&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind=&quot;私聊文件消息&quot; if message.content else &quot;私聊图文消息&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                event=&quot;处理&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                source=message.author.member_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seq=message.id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=message.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                files=files,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                group=message.group_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                robot=&quot;LR232&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind=&quot;私聊文字消息&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                event=&quot;处理&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                source=message.author.member_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seq=message.id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=message.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                files=files,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                group=message.group_openid,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def msg_content_join(content):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 转换内容中的表情包</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content = content.strip()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pattern = r&quot;&lt;faceType=(\d+),faceId=\&quot;(\d*)\&quot;.*?&gt;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    def replace_face(match):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        face_type = int(match.group(1))  # 获取 faceType</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if face_type == 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            face_id = int(match.group(2))  # 获取 faceId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            emoji_name = config[&quot;emojis&quot;].get(face_id, &quot;未知表情&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return f&quot;[{emoji_name}]&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif face_type == 4:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return &quot;[动画表情]&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return match.group(0)  # 保留原内容，适用于其他情况</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 替换所有匹配项</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return re.sub(pattern, replace_face, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def LR232_start():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    intents = botpy.Intents(public_messages=True)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    client = MyClient(intents=intents)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await client.start(appid=config[&quot;appid&quot;], secret=config[&quot;secret&quot;])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 以下是需要并入 msg_send 的 botpy 发送逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def msg_send(msg: Msg):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if msg.robot == &quot;LR232&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if msg.group:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # 发送群消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            message_instance = GroupMessage(global_api.get(&quot;api&quot;), &quot;&quot;, {})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            uploadMedia = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if msg.files:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                # 调用上传函数，传入 base64 编码的文件内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                uploadMedia = await message_instance.api.post_group_file(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    group_openid=msg.group,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    file_type=1,  # 图片类型</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    url=msg.files[0][1],  # 传入 base64 编码后的文件内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            await message_instance.api.post_group_message(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                group_openid=msg.group,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg_type=7 if uploadMedia else 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=msg.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                media=uploadMedia if uploadMedia else None,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg_id=msg.seq,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # 记录消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if msg.files:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg.content = f&quot;{msg.content}|{msg.files[0][1]}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            adapter_logger.debug(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                f&quot;⌈LR232⌋ 发送:文件{msg.content}&quot;, extra={&quot;event&quot;: &quot;消息发送&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # 发送好友消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            message_instance = C2CMessage(global_api.get(&quot;api&quot;), &quot;&quot;, {})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            uploadMedia = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if msg.files:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                # 调用上传函数，传入 base64 编码的文件内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                uploadMedia = await message_instance.api.post_c2c_file(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    openid=msg.source,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    file_type=4,  # 图片类型</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    url=msg.files[0][1],  # 传入 base64 编码后的文件内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            await message_instance.api.post_c2c_message(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                openid=msg.group,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg_type=7 if uploadMedia else 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content=msg.content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                media=uploadMedia if uploadMedia else None,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg_id=msg.seq,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if msg.files:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg.content = f&quot;{msg.content}|{msg.files[0][0]}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            adapter_logger.debug(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                f&quot;⌈LR232⌋ 发送:文件{msg.content}&quot;, extra={&quot;event&quot;: &quot;消息发送&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="weibo">weibo<a href="#weibo" class="hash-link" aria-label="Direct link to weibo" title="Direct link to weibo">​</a></h2>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>weibo 逻辑</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;&quot;&quot;微博粉丝服务平台消息接收/发送&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import hashlib</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import requests</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from fastapi import APIRouter, Response, Request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from config import config,loggers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 以下为接收</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">router = APIRouter()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">adapter_logger = loggers[&quot;adapter&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.get(&quot;/&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def set_callback(signature: str, timestamp: str, nonce: str, echostr: str):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;&quot;&quot;回调地址验证&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        token = config[&quot;WEIBO_SECRET&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list = [token, timestamp, nonce]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list.sort()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sha1 = hashlib.sha1()  # 计算SHA1哈希值</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for item in list:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            sha1.update(item.encode(&quot;utf-8&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        hashcode = sha1.hexdigest()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if hashcode == signature:  # 比对signature与计算出的hashcode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            adapter_logger.debug(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                f&quot;⌈WEIBO⌋ 消息回调配置成功&quot;, extra={&quot;event&quot;: &quot;回调配置&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response(content=echostr, media_type=&quot;text/plain&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            raise Exception(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                f&quot;回调配置错误 | 数据不完整: signature-{signature} timestamp-{timestamp} nonce-{nonce} echostr-{echostr}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        raise Exception(f&quot;回调配置错误 | 错误: {e}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@router.post(&quot;/&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def handle_post(request: Request):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(request.body())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 以下为发送</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 请求的基础信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">APP_KEY = &quot;&quot;  # 替换为你的 APP ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">APP_SECRET = &quot;&quot;  # 替换为你的 Token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def get_token():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求头</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;client_id&quot;: APP_KEY,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;client_secret&quot;: APP_SECRET,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;grant_type&quot;: &quot;authorization_code&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;code&quot;: code,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;redirect_uri&quot;: uri,  # 可以使用随机生成的 UUID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送 POST 请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response = requests.post(&quot;https://api.weibo.com/oauth2/access_token&quot;, data=headers)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Status Code: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Response Body: {response.json()}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def get_weibo():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求头</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers = {&quot;access_token&quot;: access_token, &quot;screen_name&quot;: &quot;whu推协&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送 POST 请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response = session.get(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;https://api.weibo.com/2/friendships/friends.json&quot;, params=headers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Status Code: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Response Body: {response.json()}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def get_mentions():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求头</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers = {&quot;access_token&quot;: access_token}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送 POST 请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response = session.get(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;https://api.weibo.com/2/statuses/mentions.json&quot;, params=headers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Status Code: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Response Body: {response.json()}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">get_mentions()</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wechatopen">wechatopen<a href="#wechatopen" class="hash-link" aria-label="Direct link to wechatopen" title="Direct link to wechatopen">​</a></h2>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>微信开放平台逻辑</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;&quot;&quot;微信开放平台测试代码&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import hashlib</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import requests</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 请求的基础信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">APP_ID = &quot;&quot;  # 替换为你的 APP ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TOKEN = &quot;&quot;  # 替换为你的 Token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ACCOUNT = &quot;&quot;  # 替换为你的账户</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">key = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">access_token = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">task_id1 = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def generate_sign(token, timestamp, nonce, body):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    根据文档生成签名 sign = md5(Token + str(unix_timestamp) + nonce + md5(body))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body_md5 = hashlib.md5(body.encode(&quot;utf-8&quot;)).hexdigest()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sign_str = f&quot;{token}{timestamp}{nonce}{body_md5}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sign = hashlib.md5(sign_str.encode(&quot;utf-8&quot;)).hexdigest()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return sign</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def send_request():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 时间戳和随机字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    timestamp = int(time.time())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nonce = &quot;abc&quot;  # 这里可以使用更复杂的随机字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url = &quot;https://openaiapi.weixin.qq.com/v2/token&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body = json.dumps({&quot;account&quot;: ACCOUNT})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 生成签名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sign = generate_sign(TOKEN, timestamp, nonce, body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求头</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;X-APPID&quot;: APP_ID,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;request_id&quot;: &quot;&quot;,  # 可以使用随机生成的 UUID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;timestamp&quot;: str(timestamp),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;nonce&quot;: nonce,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;sign&quot;: sign,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;content-type&quot;: &quot;application/json&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送 POST 请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response = requests.post(url, headers=headers, data=body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Status Code: {response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(f&quot;Response Body: {response.json()}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def import_simple_qna():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 时间戳和随机字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    timestamp = int(time.time())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nonce = &quot;abc&quot;  # 这里可以用随机生成的字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url = &quot;https://openaiapi.weixin.qq.com/v2/bot/import/json&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body = json.dumps(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;mode&quot;: 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;data&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;skill&quot;: &quot;AAA&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;intent&quot;: &quot;BBC&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;threshold&quot;: &quot;0.9&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;disable&quot;: False,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;questions&quot;: [&quot;q&quot;, &quot;q2&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;answers&quot;: [&quot;a&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 生成签名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sign = generate_sign(TOKEN, timestamp, nonce, body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求头</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    headers = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;content-type&quot;: &quot;application/json&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;X-OPENAI-TOKEN&quot;: access_token,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;request_id&quot;: ACCOUNT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;timestamp&quot;: str(timestamp),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;nonce&quot;: nonce,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;sign&quot;: sign,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送 POST 请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    response = requests.post(url, headers=headers, data=body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 打印响应结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if response.status_code == 200:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        print(&quot;导入成功！返回数据：&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        print(response.json())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        print(f&quot;导入失败，状态码：{response.status_code}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        print(response.text)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def query_qna(task_id):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    timestamp = int(time.time())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nonce = &quot;abc&quot;  # 这里可以用随机生成的字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url = &quot;https://openaiapi.weixin.qq.com/v2/async/fetch&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 请求体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body = json.dumps({&quot;task_id&quot;: task_id})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 生成签名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sign = generate_sign(TOKEN, timestamp, nonce, body)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    send_request()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # import_simple_qna()</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="llonebot">LLOneBot<a href="#llonebot" class="hash-link" aria-label="Direct link to LLOneBot" title="Direct link to LLOneBot">​</a></h2>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>LLOneBot 原代码逻辑</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import re</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import asyncio</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import traceback</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import websockets</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from datetime import datetime</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from zoneinfo import ZoneInfo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from lrobot.config import config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from lrobot.log import robot_log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from lrobot.database import add_users, activities_edit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from lrobot.event.point import get_speakers, task_queue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from lrobot.msg import Msg, msg_log, msg_add, global_ws, set_global_ws</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def LR5921_start():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    websocket_url = &quot;ws://localhost:5921&quot;  # LLOneBot连接端口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        async with websockets.connect(websocket_url) as ws:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            set_global_ws(ws)  # 全局共享ws连接</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            await on_open()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            await on_message()  # WebSocket 消息接收和处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    except Exception:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        error_message = traceback.format_exc()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log_event(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;LRobot&quot;, &quot;系统未知错误&quot;, f&quot;WebSocket connection error: {error_message}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def on_open():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    log_event(&quot;LR5921&quot;, &quot;机器启动&quot;, &quot;启动成功&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    asyncio.create_task(get_speakers())  # 每日发言逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def on_message():</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        async for message in global_ws.get(&quot;ws&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            data = json.loads(message)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if &quot;status&quot; in data and data[&quot;status&quot;] == &quot;ok&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                await echo_deal(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;post_type&quot; in data:  # 收到 WS 事件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if data.get(&quot;post_type&quot;) == &quot;message&quot;:  # 消息事件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    await message_deal(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                elif data.get(&quot;post_type&quot;) == &quot;notice&quot;:  # 通知事件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    log_event(&quot;LR5921&quot;, &quot;通知事件调试&quot;, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    is_group_recall = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        data.get(&quot;notice_type&quot;) == &quot;group_recall&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        and str(data.get(&quot;group_id&quot;)) == config[&quot;测试群&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    )  # 群聊撤回</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    is_friend_recall = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        data.get(&quot;notice_type&quot;) == &quot;friend_recall&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    )  # 私聊撤回</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    is_poked = data.get(&quot;sub_type&quot;) == &quot;poke&quot; and str(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        data.get(&quot;target_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ) in [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        config[&quot;LR5921&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        config[&quot;LR232&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ]  # 戳戳</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    is_liked = (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        data.get(&quot;notice_type&quot;) == &quot;group_msg_emoji_like&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    )  # 群消息被表态</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    if is_group_recall or is_friend_recall:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        await revoke(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    elif is_poked:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        await get_poke(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    elif is_liked:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        await get_like(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            #  不处理请求事件和元事件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                # WS返回failed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                log_event(&quot;LR5921&quot;, &quot;WS回应调试&quot;, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    except Exception:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        error_message = traceback.format_exc()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log_event(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;LRobot&quot;, &quot;系统未知错误&quot;, f&quot;WebSocket massage_deal error: {error_message}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_deal(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 处理 WS 回应的消息，echo为附属信息字段，收发一致</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    log_event(&quot;LR5921&quot;, &quot;WS回应调试&quot;, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    echo = data.get(&quot;echo&quot;, &quot;&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    data = data.get(&quot;data&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if echo.startswith(&quot;msg_send&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_msg_send(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;msg_get&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_msg_get(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;get_like&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_get_like(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;revoke&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_revoke(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;flush_speak&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_flush_speak(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;get_speak&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_get_speak(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;get_talkative&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_get_talkative(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;get_users&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_get_users(data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;get_file&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_get_file(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;add_activities&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_add_activities(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elif echo.startswith(&quot;add_activity_group&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await echo_add_activity_group(echo, data)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log_event(&quot;LRobot&quot;, &quot;系统未知错误&quot;, f&quot;未知的WS回应{echo}|{data}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def message_deal(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 消息处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg_content = data.get(&quot;message&quot;)  # 原始消息段格式（数组）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    log_event(&quot;LR5921&quot;, &quot;消息接收调试&quot;, msg_content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content, info, name, url, at = await segment_join(msg_content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if not content and not name:  # 不处理空格消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if data.get(&quot;message_type&quot;) == &quot;private&quot;:  # 私聊消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if info:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            kind = 13  # 好友回复</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if content:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if name:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    kind = 11</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    kind = 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 12</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:  # 群聊消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if info:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if at == 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 33  # 配对消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif at == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 23  # 群聊回复</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content = &quot;[回复消息]&quot; + content</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 34</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if at == 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 33  # 配对消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif at == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if content:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    if name:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        kind = 11</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        kind = 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    kind = 12</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                kind = 34</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # # 内阁管家特殊处理，不用@快捷使用指令</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # keywords = [&quot;记：&quot;, &quot;等：&quot;, &quot;催：&quot;, &quot;示：&quot;, &quot;删：&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # if kind == 12 and str(data.get(&#x27;group_id&#x27;)) == config[&quot;内阁&quot;] and any(keyword in content for keyword in keywords):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #     kind = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        robot=&quot;LR5921&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content=content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kind=kind,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        info=info,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        file_name=name,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        file_url=url,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        group=None if data.get(&quot;message_type&quot;) == &quot;private&quot; else data.get(&quot;group_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        qq=data.get(&quot;user_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        seq=data.get(&quot;message_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await msg_add(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def segment_join(content):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content_parts = []</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 支持识别表情混合文字、图片混合文字、语音、视频、文件、掷骰子、猜拳、合并转发</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 目前推荐好友、群聊、位置分享、链接分享、音乐分享都是json格式，视频是文件格式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info_updated = False  # 只识别第一个文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url = &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    at = 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for item in content:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg_type = item.get(&quot;type&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg_data = item.get(&quot;data&quot;, {})</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if msg_type == &quot;text&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(msg_data.get(&quot;text&quot;, &quot;&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;face&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            face_id = msg_data.get(&quot;id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            face_id = config[&quot;emojis&quot;].get(int(face_id), &quot;未知表情&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(f&quot;[{face_id}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;mface&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            face_id = msg_data.get(&quot;summary&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(face_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;rps&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rps_id = msg_data.get(&quot;result&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rps_mapping = {&quot;1&quot;: &quot;布&quot;, &quot;2&quot;: &quot;剪刀&quot;, &quot;3&quot;: &quot;石头&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rps_result = rps_mapping.get(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                rps_id, &quot;未知结果&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )  # 默认值为&#x27;未知结果&#x27;，如果rps_id不在映射中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(f&quot;[猜拳:{rps_result}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;dice&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            dice_id = msg_data.get(&quot;result&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(f&quot;[掷骰子{dice_id}点]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;forward&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(f&quot;[合并转发消息]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;node&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(f&quot;[合并转发节点]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;image&quot; and not info_updated:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name = msg_data.get(&quot;file&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            url = msg_data.get(&quot;url&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;record&quot; and not info_updated:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name = msg_data.get(&quot;file&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            url = msg_data.get(&quot;url&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;file&quot; and not info_updated:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name = msg_data.get(&quot;file&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # 此处是未下载的msg_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            url = msg_data.get(&quot;file_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;reply&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # 回复的消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            info = msg_data.get(&quot;id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        elif msg_type == &quot;at&quot;:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            qq = msg_data.get(&quot;qq&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if qq == config[&quot;LR232&quot;]:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                at = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif qq == config[&quot;LR5921&quot;] and at != 1:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                at = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                user = msg_data.get(&quot;name&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[@{user}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log_event(&quot;LRobot&quot;, &quot;系统未知错误&quot;, f&quot;收到无法解析的消息：{item}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content_join = &quot;&quot;.join(content_parts)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return content_join, info, name, url, at</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def array_join(content):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 获取发送的消息、撤回的消息、回应的消息（get_file的数组格式)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 使用re.split将内容按[CQ:...]格式切分</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    items = re.split(r&quot;(\[CQ:.*?\])&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content_parts = []</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for item in items:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if not item:  # 跳过空字符串</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            continue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if item.startswith(&quot;[CQ:&quot;):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if &quot;CQ:text&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;text=([^]]+)]&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(match.group(1))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:face&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;id=([^]]+)]&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                face_id = config[&quot;emojis&quot;].get(int(match.group(1)), &quot;未知表情&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[{face_id}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:mface&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;summary=([^,]+),&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(match.group(1))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:rps&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;result=([^]]+)]&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                rps_mapping = {&quot;1&quot;: &quot;布&quot;, &quot;2&quot;: &quot;剪刀&quot;, &quot;3&quot;: &quot;石头&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                rps_result = rps_mapping.get(match.group(1), &quot;未知结果&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[猜拳:{rps_result}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:mface&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;result=([^]]+)]&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[掷骰子{match.group(1)}点]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:forward&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[合并转发消息]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:node&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[合并转发节点]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:image&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;file=([^,]+),&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[图片{match.group(1)}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:record&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;file=([^,]+),&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[音频{match.group(1)}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:file&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;file=([^,]+),&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[文件{match.group(1)}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:reply&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[回复消息]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            elif &quot;CQ:at&quot; in item:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                match = re.search(r&quot;qq=([^]]+)]&quot;, content)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                content_parts.append(f&quot;[@{match.group(1)}]&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                log_event(&quot;LRobot&quot;, &quot;系统未知错误&quot;, f&quot;收到无法解析的消息：{item}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content_parts.append(item)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content_join = &quot;&quot;.join(content_parts)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return content_join</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def revoke(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #  获取撤回消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;action&quot;: &quot;get_msg&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;params&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;message_id&quot;: data.get(&quot;message_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;echo&quot;: &quot;revoke&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await global_ws.get(&quot;ws&quot;).send(json.dumps(info))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def get_poke(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 被戳了</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        robot=&quot;LR5921&quot; if str(data.get(&quot;target_id&quot;)) == config[&quot;LR5921&quot;] else &quot;LR232&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content=&quot;戳戳&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kind=24 if data.get(&quot;group_id&quot;) else 14,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        group=data.get(&quot;group_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        qq=data.get(&quot;user_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await msg_add(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def get_like(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 被点赞了</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    user_id = data.get(&quot;user_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    like_id = data.get(&quot;likes&quot;)[0].get(&quot;emoji_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;action&quot;: &quot;get_msg&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;params&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;message_id&quot;: data.get(&quot;message_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;echo&quot;: &quot;get_like&quot; + &quot;|&quot; + str(like_id) + &quot;|&quot; + str(user_id),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await global_ws.get(&quot;ws&quot;).send(json.dumps(info))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_msg_send(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送消息的回应</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        user_id = parts[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;action&quot;: &quot;get_msg&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;params&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;message_id&quot;: data.get(&quot;message_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;echo&quot;: f&quot;msg_get|{user_id}&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await global_ws.get(&quot;ws&quot;).send(json.dumps(info))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_msg_get(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 获取发送的消息并记录</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        user_id = parts[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content = await array_join(data.get(&quot;raw_message&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            robot=&quot;LR5921&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content=content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            kind=31 if data.get(&quot;message_type&quot;) == &quot;private&quot; else 32,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            group=data.get(&quot;group_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            qq=user_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await msg_log(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_get_like(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 获取回应的原消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 3:  # 确保分割后的数组有 3 部分</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        like_id = parts[1]  # 提取 like_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        user_id = parts[2]  # 提取 user_id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content = await array_join(data.get(&quot;raw_message&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            robot=&quot;LR5921&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content=content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            kind=35,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            info=config[&quot;emojis&quot;].get(int(like_id), &quot;未知表情&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            group=data.get(&quot;group_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            qq=user_id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await msg_add(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_revoke(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 获取撤回的原消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content = await array_join(data.get(&quot;raw_message&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        robot=&quot;LR5921&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content=content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kind=19 if data.get(&quot;message_type&quot;) == &quot;private&quot; else 29,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        group=data.get(&quot;group_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        qq=data.get(&quot;user_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await msg_add(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_flush_speak(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 刷新群成员最后发言时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    asia_tz = ZoneInfo(&quot;Asia/Shanghai&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    today_start = datetime.now(asia_tz).replace(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        hour=0, minute=0, second=0, microsecond=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    today_start = int(today_start.timestamp())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for user in data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        last_sent_time = user[&quot;last_sent_time&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if last_sent_time &lt; today_start:  # 只刷新未显示今日发言的</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;action&quot;: &quot;get_group_member_info_rate_limited&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;params&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;group_id&quot;: config[&quot;水群&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;user_id&quot;: user[&quot;user_id&quot;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &quot;no_cache&quot;: True,  # 强制刷新缓存</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            await task_queue.put(info)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_get_speak(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #  获取今日发言的人</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    asia_tz = ZoneInfo(&quot;Asia/Shanghai&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    today_start = datetime.now(asia_tz).replace(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        hour=0, minute=0, second=0, microsecond=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )  # 获取今天的开始时间戳（从零点开始）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    today_start = int(today_start.timestamp())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    today_speakers = []</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for user in data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        last_sent_time = user[&quot;last_sent_time&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if last_sent_time &gt;= today_start:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            today_speakers.append(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                {&quot;nickname&quot;: user[&quot;nickname&quot;], &quot;user_id&quot;: user[&quot;user_id&quot;]}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content = &quot;今日水群发言:&quot; + &quot;,&quot;.join(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        speaker[&quot;nickname&quot;] for speaker in today_speakers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送至内阁</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;action&quot;: &quot;send_msg&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;params&quot;: {&quot;group_id&quot;: config[&quot;内阁&quot;], &quot;message&quot;: content},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;echo&quot;: &quot;msg_send&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await global_ws.get(&quot;ws&quot;).send(json.dumps(info))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_get_talkative(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    user_id = data[&quot;current_talkative&quot;][&quot;user_id&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nickname = data[&quot;current_talkative&quot;][&quot;nickname&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 发送至内阁</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    content = &quot;今日水群龙王:&quot; + nickname</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    info = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;action&quot;: &quot;send_msg&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;params&quot;: {&quot;group_id&quot;: config[&quot;内阁&quot;], &quot;message&quot;: content},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;echo&quot;: &quot;msg_send&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await global_ws.get(&quot;ws&quot;).send(json.dumps(info))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_get_users(data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 获取群成员</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if data[0][&quot;group_id&quot;] == 920712228:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 水群和平台群</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        i = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # 社员群</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        i = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    user_list = [(user[&quot;user_id&quot;], user[&quot;nickname&quot;]) for user in data]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    await add_users(user_list, i)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_get_file(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        qq = parts[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        url = data.get(&quot;file&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        content = os.path.basename(url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg = Msg(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            robot=&quot;LR5921&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            content=content,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            kind=5,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            file_url=url,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            qq=qq,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            seq=data.get(&quot;message_id&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await msg_add(msg)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_add_activities(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 添加活动的消息序号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        task_id = parts[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        msg_id = data.get(&quot;message_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await activities_edit(task_id, &quot;msg_id&quot;, msg_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">async def echo_add_activity_group(echo, data):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    print(1)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 添加活动的二维码图片序号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parts = echo.split(&quot;|&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if len(parts) == 2:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        task_id = parts[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pic_id = data.get(&quot;message_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        print(pic_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        await activities_edit(task_id, &quot;pic_id&quot;, pic_id)</span><br></span></code></pre></div></div></div></div></details></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Lrobot/en/docs/category/平台进阶配置"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">平台进阶配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Lrobot/en/docs/2使用指南/7平台进阶配置/平台回调原理"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">平台回调原理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#qqapp参考" class="table-of-contents__link toc-highlight">qqapp(参考)</a></li><li><a href="#botpy" class="table-of-contents__link toc-highlight">botpy</a></li><li><a href="#weibo" class="table-of-contents__link toc-highlight">weibo</a></li><li><a href="#wechatopen" class="table-of-contents__link toc-highlight">wechatopen</a></li><li><a href="#llonebot" class="table-of-contents__link toc-highlight">LLOneBot</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Lrobot/en/docs/1项目总览/1快速开始">快速开始</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/en/docs/1项目总览/5更新日志">更新日志</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/en/docs/1项目总览/4常见问题">常见问题</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Lrobot/en/">QQ : 3502644244</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/en/">输入 &quot;/留言xxx&quot; 来留言或获取帮助 </a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/wwweibu/Lrobot" target="_blank" rel="noopener noreferrer" class="footer__link-item">项目仓库<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://whumystery.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">社团官网<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 微步. Lrobot</div></div></div></footer></div>
</body>
</html>