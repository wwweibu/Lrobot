<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-2使用指南/项目进阶配置/其他服务配置" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">其他服务配置 | Lrobot</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://wwweibu.github.io/Lrobot/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://wwweibu.github.io/Lrobot/img/logo.png"><meta data-rh="true" property="og:url" content="https://wwweibu.github.io/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="其他服务配置 | Lrobot"><meta data-rh="true" name="description" content="grafana 系列、小米球等配置指南"><meta data-rh="true" property="og:description" content="grafana 系列、小米球等配置指南"><link data-rh="true" rel="icon" href="/Lrobot/img/logo.png"><link data-rh="true" rel="canonical" href="https://wwweibu.github.io/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/en/docs/2使用指南/项目进阶配置/其他服务配置" hreflang="en"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://wwweibu.github.io/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"使用指南","item":"https://wwweibu.github.io/Lrobot/docs/category/使用指南"},{"@type":"ListItem","position":2,"name":"项目进阶配置","item":"https://wwweibu.github.io/Lrobot/docs/category/项目进阶配置"},{"@type":"ListItem","position":3,"name":"其他服务配置","item":"https://wwweibu.github.io/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置"}]}</script><link rel="stylesheet" href="/Lrobot/assets/css/styles.128759fc.css">
<script src="/Lrobot/assets/js/runtime~main.a58a6c42.js" defer="defer"></script>
<script src="/Lrobot/assets/js/main.14492a2a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Lrobot/img/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Lrobot/"><div class="navbar__logo"><img src="/Lrobot/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Lrobot/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Lrobot</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Lrobot/docs/category/项目总览">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/wwweibu/Lrobot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/docs/category/项目总览">项目总览</a><button aria-label="展开侧边栏分类 &#x27;项目总览&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Lrobot/docs/category/使用指南">使用指南</a><button aria-label="折叠侧边栏分类 &#x27;使用指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/docs/2使用指南/1运行机配置">运行机配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/docs/2使用指南/2Docker配置">Docker 配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/docs/2使用指南/3平台配置">平台配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/docs/2使用指南/4服务器配置">服务器配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Lrobot/docs/2使用指南/5后续开发">后续开发</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/Lrobot/docs/category/平台进阶配置">平台进阶配置</a><button aria-label="展开侧边栏分类 &#x27;平台进阶配置&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/Lrobot/docs/category/项目进阶配置">项目进阶配置</a><button aria-label="折叠侧边栏分类 &#x27;项目进阶配置&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Lrobot/docs/2使用指南/项目进阶配置/其他服务配置">其他服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/Lrobot/docs/2使用指南/功能开发/新增功能">功能开发</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/docs/category/开发指南">开发指南</a><button aria-label="展开侧边栏分类 &#x27;开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Lrobot/docs/category/项目测试">项目测试</a><button aria-label="展开侧边栏分类 &#x27;项目测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/Lrobot/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/Lrobot/docs/category/使用指南"><span>使用指南</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/Lrobot/docs/category/项目进阶配置"><span>项目进阶配置</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">其他服务配置</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>其他服务配置</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="grafana-系列服务配置指南">grafana 系列服务配置指南<a href="#grafana-系列服务配置指南" class="hash-link" aria-label="grafana 系列服务配置指南的直接链接" title="grafana 系列服务配置指南的直接链接">​</a></h2>
<ul>
<li>从 grafana <a href="https://grafana.com/zh-cn/grafana/?pg=graf&amp;plcmt=hero-btn-1#grafana-versions" target="_blank" rel="noopener noreferrer">官网</a>下载 grafana，如要更改端口则修改 conf/defaults.ini 的 http_port = 5930</li>
<li>从 prometheus <a href="https://prometheus.io/download/" target="_blank" rel="noopener noreferrer">官网</a>下载 prometheus</li>
<li>配置 prometheus.yml</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">global:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  scrape_interval: 15s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  evaluation_interval: 15s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - job_name: &quot;prometheus&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - targets: [&quot;localhost:5926&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - job_name: &quot;windows_exporter&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - targets: [&quot;localhost:5924&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - job_name: &quot;application_metrics&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - targets: [ &quot;localhost:5925&quot; ]</span><br></span></code></pre></div></div>
<ul>
<li>新建 prometheus.bat <code>prometheus.exe --config.file=prometheus.yml --web.listen-address=&quot;:5926&quot;</code></li>
<li>需要在本地的 5923 配置一个 ws 连接，定时发送 SERVICE_STATUS（定义的 prometheus 指标），接收 grafana 的后端返回结果</li>
<li>从 windows-exporter <a href="https://github.com/prometheus-community/windows_exporter/releases" target="_blank" rel="noopener noreferrer">官网</a>下载 windows-exporter</li>
<li>配置 windows-exporter.yml</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">collectors:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  enabled: cpu,cs,logical_disk,net,os,service,system</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">collector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  service:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include: &quot;windows_exporter&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  scheduled_task:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include: /Microsoft/.+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  level: debug</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scrape:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  timeout-margin: 0.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">telemetry:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path: /metrics</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max-requests: 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">web:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  listen-address: &quot;:5924&quot;</span><br></span></code></pre></div></div>
<ul>
<li>新建 windows-exporter.bat <code>windows_exporter-0.30.0-beta.4-amd64.exe --config.file=&quot;windows_exporter.yml&quot;</code></li>
<li>访问 <a href="http://localhost:5926" target="_blank" rel="noopener noreferrer">http://localhost:5926</a> ，访问<a href="http://localhost:5924/metrics" target="_blank" rel="noopener noreferrer">http://localhost:5924/metrics</a> 确认 windows-exporter 启动，配置 rate(interface_tx_bytes_total)</li>
<li>从 loki <a href="https://github.com/grafana/loki/releases" target="_blank" rel="noopener noreferrer">官网</a>下载 loki</li>
<li>配置 loki.yml</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">auth_enabled: false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  http_listen_port: 5927</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  log_level: info</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">common:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ring:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    instance_addr: 127.0.0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kvstore:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      store: inmemory</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  replication_factor: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path_prefix: loki</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">schema_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - from: 2020-05-15</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    store: tsdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    object_store: filesystem</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    schema: v13</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    index:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      prefix: index_</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      period: 24h</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">storage_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  filesystem:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    directory: chunks</span><br></span></code></pre></div></div>
<ul>
<li>新建 loki.bat <code>@echo off \n chcp 65001 \n loki-windows-amd64.exe -config.file=loki.yml</code></li>
<li>从 loki <a href="https://github.com/grafana/loki/releases" target="_blank" rel="noopener noreferrer">官网</a>下载 promtail</li>
<li>配置 promtail.yml</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  http_listen_port: 5928</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  grpc_listen_port: 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">positions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  filename: positions.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">clients:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - url: http://localhost:5927/loki/api/v1/push</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scrape_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- job_name: service_logs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      job: service_logs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      __path__: ../service.log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  pipeline_stages:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - json:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        expressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          level: level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          time: time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          service: service  # 从日志内容中提取 service 字段作为标签</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          message: message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        level: level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        time: time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        service: service  # 从日志内容中提取 service 字段作为标签</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message: message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- job_name: robot_logs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  static_configs:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - targets:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      job: robot_logs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      __path__: ../robot.log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  pipeline_stages:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - json:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        expressions:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          level: level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          time: time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          robot: robot</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          event: event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          command: command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          target: target</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          message: message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        level: level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        time: time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        robot: robot</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        event: event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        command: command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target: target</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        message: message</span><br></span></code></pre></div></div>
<ul>
<li>新建 promtail.bat <code>@echo off \n chcp 65001 \n promtail-windows-amd64.exe -config.file=promtail.yml</code></li>
<li>安装包 <code>pip install prometheus_client</code>，将 <a href="https://github.com/wwweibu/Lrobot/tree/master/storage/abandoned/service.py" target="_blank" rel="noopener noreferrer">service.py</a>里的 start_services(),monitor_services() 和 stop_services()分别放在 main 里面的 start、tasks、stop 中，将最后面的 filter 移动至 log.py，运行</li>
<li>以上所有文件夹都放置在 lrobot 同级位置</li>
<li>访问 <a href="http://localhost:3000" target="_blank" rel="noopener noreferrer">http://localhost:3000</a> ，settings-data sources-add data source，选择 Prometheus 和 Loki，地址分别为 <a href="http://localhost:5926" target="_blank" rel="noopener noreferrer">http://localhost:5926</a> 和 <a href="http://localhost:5927" target="_blank" rel="noopener noreferrer">http://localhost:5927</a></li>
<li>在仪表盘中根据 windows-exporter 配置上下行网速；设置 loki 查询面板，根据 level 和 robot 筛选；使用 web 组件与 5923 端口通信，实现指标的展示与反馈</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="日志格式">日志格式<a href="#日志格式" class="hash-link" aria-label="日志格式的直接链接" title="日志格式的直接链接">​</a></h2>
<ul>
<li>以下为自启动与代码启动的日志对比，日志格式转化可以在<a href="https://github.com/wwweibu/Lrobot/tree/master/storage/abandoned/service.py" target="_blank" rel="noopener noreferrer">service.py</a>中找到</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="napcat">napcat<a href="#napcat" class="hash-link" aria-label="napcat的直接链接" title="napcat的直接链接">​</a></h4>
<ul>
<li>自启动 <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/3-0f5ad6b8d6c6bfdaf7d0dde50b6684b6.png" width="1692" height="715" class="img_ev3q"></li>
<li>代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/4-e640e5e2cafa18ba499ce1bc8f33b11e.png" width="2371" height="822" class="img_ev3q"><img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/5-5b9ce16c99c200edd31c3abd3d63ea1d.png" width="2320" height="780" class="img_ev3q"></li>
<li>代码启动会多出很多可能是 node.js 里面出现而在控制台里不出现的内容，所以把这些以&quot;[]&quot;开头的内容简单地识别进debug里（包括会在控制台里出现的<code>[NapCat Backend] Main Process ID:22820</code>）启动的 qq 进程 id</li>
<li>断网后会显示:12-05 14:51:56 [info] LR5921 | 账号状态变更为离线</li>
<li>错误（warn）的测试还没有找到，等待发送消息流程搭建完成后测试</li>
<li><em>修改后输出相同的日志，除了从<code>[NapCat Backend]</code> 到<code>NapCat Shell App Loading...</code>中间的8行仍然保留</em></li>
<li><em>修改后可以识别中文</em></li>
<li><em>修改后忽略了 active 那一句</em></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="xiaomiqiu">xiaomiqiu<a href="#xiaomiqiu" class="hash-link" aria-label="xiaomiqiu的直接链接" title="xiaomiqiu的直接链接">​</a></h4>
<ul>
<li>自启动 <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/6-e03eb7fea150b68bb96c203bc1e941fa.png" width="1702" height="247" class="img_ev3q"></li>
<li>自启动会显示一个状态表，正常是 connect，断网后是 connecting</li>
<li>正常启动的输出只有几行 <img decoding="async" loading="lazy" alt="正常启动" src="/Lrobot/assets/images/7-d1a512c9aee9f93843a398458b0cc957.png" width="2267" height="194" class="img_ev3q">，即使用跟 loki 一样的重定向方法，内部输出语句的优先级仍然高于控制台，会输出到最新日志的文件夹里</li>
<li>日志输出 <img decoding="async" loading="lazy" alt="日志输出" src="/Lrobot/assets/images/8-85430e7a1b7a73acc5c13681e27f6874.png" width="1754" height="439" class="img_ev3q"></li>
<li>修改后代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/9-9ef910fded06bb12b6ecc1a4d13ff50e.png" width="2253" height="432" class="img_ev3q"></li>
<li>但当断网时不会把日志等级设为 error，需要在 log 里增加判断 <img decoding="async" loading="lazy" alt="错误输出" src="/Lrobot/assets/images/10-a1b90a2f14dcb896c995edee4cb1b41e.png" width="1705" height="174" class="img_ev3q"></li>
<li>断网时启动会直接设为 error</li>
<li>另外，这个也是 go 语言</li>
<li><em>修改后简化了正则表达式</em></li>
<li><em>修改后支持识别中文</em></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="windows_exporter">windows_exporter<a href="#windows_exporter" class="hash-link" aria-label="windows_exporter的直接链接" title="windows_exporter的直接链接">​</a></h4>
<ul>
<li>日志较少，自启动时仅仅有几条日志，然后访问 /metrics 或 /health 时只会有几条debug <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/11-2f4eb27955ef4076900d46157147616e.png" width="1989" height="727" class="img_ev3q"></li>
<li>当端口被占用时程序会直接终止且没有任何日志，需要靠 monitor 去发现</li>
<li>并且这个也是 go，并且创建文件比 loki 慢，loki 启动非常快导致日志文件必须从开头读，这个启动非常慢导致1.必须结束后删除日志文件2.必须循环等待日志文件读取</li>
<li>调试完成后日志（控制台相同） <img decoding="async" loading="lazy" alt="txt日志" src="/Lrobot/assets/images/12-9451b859ba590b4a0fb49b626a29791b.png" width="1873" height="388" class="img_ev3q"></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">prometheus<a href="#prometheus" class="hash-link" aria-label="prometheus的直接链接" title="prometheus的直接链接">​</a></h4>
<ul>
<li>自启动 <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/13-699f67d83fd90a611aeef3c64868a562.png" width="1714" height="1446" class="img_ev3q"></li>
<li>代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/14-c82ff4c7eabb96bf074b5baf5ce033c4.png" width="2340" height="959" class="img_ev3q"></li>
<li>在处理 Prometheus 输出的时候发现只需要 asyncio.create_subprocess_shell 里面不加 pipe 捕获，就可以正常输出（但不能捕获） windows_exporter 的所有日志，故删除了之前的逻辑</li>
<li>然后发现 napcat 输出不加 pipe 捕获，就捕获不了日志而是直接输出到控制台</li>
<li>然后换 ai 重构了代码</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="grafana">grafana<a href="#grafana" class="hash-link" aria-label="grafana的直接链接" title="grafana的直接链接">​</a></h4>
<ul>
<li>自启动 <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/15-4e1795f9ff708b6339aed3cfd76f0f6c.png" width="1694" height="779" class="img_ev3q"></li>
<li>代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/16-2de2717c33db97c986dd99234df85cba.png" width="2288" height="842" class="img_ev3q"></li>
<li>基本一样，但自启动有特殊格式</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="loki">loki<a href="#loki" class="hash-link" aria-label="loki的直接链接" title="loki的直接链接">​</a></h4>
<ul>
<li>自启动(比较慢) <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/17-af90706287230f59768808bd0274bb03.png" width="1724" height="848" class="img_ev3q"></li>
<li>代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/18-3e9d68052f6d3c28682cbfe8c674f168.png" width="2379" height="855" class="img_ev3q"></li>
<li>一样的，启动比较慢，然后可以使用 <code>netstat -ano | findstr :5927和tasklist | findstr 19528</code>来查看 loki 是否正常关闭（会过一会关闭），<a href="http://localhost:5927/metrics" target="_blank" rel="noopener noreferrer">http://localhost:5927/metrics</a> 和 <a href="http://localhost:5927/ready" target="_blank" rel="noopener noreferrer">http://localhost:5927/ready</a> 都可以访问</li>
<li>在日志归类时发现了 loki 存在一些不含 msg 的日志：<code>level=info ts=2024-12-09T08:03:21.0071912Z caller=metrics.go:386 org_id=fake traceID=400f7ba8831fd4c3 latency=fast query_type=stats start=2024-12-09T09:58:19+08:00 end=2024-12-09T09:59:30+08:00 start_delta=6h5m2.0071912s end_delta=6h3m51.0071912s length=1m11s duration=1.0007ms status=200 query=\&quot;{job=\\\&quot;logs\\\&quot;, service=~\\\&quot;grafana\\\&quot;, level=~\\\&quot;.*\\\&quot;}\&quot; query_hash=3442096169 total_entries=1</code></li>
<li>故把 caller 后面的全部作为 msg 消息提取</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="promtail">promtail<a href="#promtail" class="hash-link" aria-label="promtail的直接链接" title="promtail的直接链接">​</a></h4>
<ul>
<li>自启动 <img decoding="async" loading="lazy" alt="自启动" src="/Lrobot/assets/images/19-18ce0829f319b26c5f3297198ea6faba.png" width="1712" height="843" class="img_ev3q"></li>
<li>代码启动 <img decoding="async" loading="lazy" alt="代码启动" src="/Lrobot/assets/images/20-a22b35da8af83eae0a4c7775a825a7d7.png" width="2374" height="405" class="img_ev3q"></li>
<li>单独启动 promtail，不启动 loki 时会一直尝试往loki发送消息</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/Lrobot/docs/category/项目进阶配置"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">项目进阶配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Lrobot/docs/2使用指南/功能开发/新增功能"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">新增功能</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#grafana-系列服务配置指南" class="table-of-contents__link toc-highlight">grafana 系列服务配置指南</a></li><li><a href="#日志格式" class="table-of-contents__link toc-highlight">日志格式</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Lrobot/docs/1项目总览/1快速开始">快速开始</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/docs/1项目总览/5更新日志">更新日志</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/docs/1项目总览/4常见问题">常见问题</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Lrobot/">QQ : 3502644244</a></li><li class="footer__item"><a class="footer__link-item" href="/Lrobot/">输入 &quot;/留言xxx&quot; 来留言或获取帮助 </a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/wwweibu/Lrobot" target="_blank" rel="noopener noreferrer" class="footer__link-item">项目仓库<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://whumystery.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">社团官网<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 微步. Lrobot</div></div></div></footer></div>
</body>
</html>